(window.webpackJsonp=window.webpackJsonp||[]).push([[89],{284:function(e,r,v){"use strict";v.r(r);var t=v(2),a=Object(t.a)({},function(){var e=this,r=e.$createElement,v=e._self._c||r;return v("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[v("h1",{attrs:{id:"service-worker的生命周期及使用场景"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#service-worker的生命周期及使用场景","aria-hidden":"true"}},[e._v("#")]),e._v(" Service Worker的生命周期及使用场景")]),e._v(" "),v("p",[v("img",{attrs:{src:"https://image-static.segmentfault.com/204/160/2041604797-5aea860b24105_articlex",alt:"图片描述"}})]),e._v(" "),v("p",[e._v("你可能已经知道，"),v("a",{attrs:{href:"https://developers.google.com/web/progressive-web-apps/",target:"_blank",rel:"noopener noreferrer"}},[e._v("渐进式Web应用程序"),v("OutboundLink")],1),e._v(" 只会越来越受欢迎，因为它们的目标是让Web应用程序用户体验更流畅，创建类似于原生应用程序的体验，而不是浏览器的外观和感觉。")]),e._v(" "),v("p",[e._v("构建渐进式Web应用程序的主要要求之一是使其在网络和加载方面非常可靠——它应该在不确定或不存在的网络条件下可用。")]),e._v(" "),v("p",[e._v("在这篇文章中，将深入探讨 "),v("strong",[e._v("Service Workers")]),e._v(":它们是如何工作，你应该关心什么。最后，还列出了 Service Workers 中的一些独特优点在哪些场景下是值得我们使用的。")]),e._v(" "),v("h2",{attrs:{id:"_1-简介"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#_1-简介","aria-hidden":"true"}},[e._v("#")]),e._v(" 1. 简介")]),e._v(" "),v("p",[e._v("如果你还想了解更多 "),v("strong",[e._v("Service Workers")]),e._v(" 的知识，可以阅读作者关于 "),v("a",{attrs:{href:"https://segmentfault.com/a/1190000017578650",target:"_blank",rel:"noopener noreferrer"}},[e._v("Web Workers"),v("OutboundLink")],1),e._v(" 的文章。")]),e._v(" "),v("h4",{attrs:{id:"_1-1-service-worker是什么"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-service-worker是什么","aria-hidden":"true"}},[e._v("#")]),e._v(" "),v("strong",[e._v("1.1 Service Worker是什么")])]),e._v(" "),v("p",[v("a",{attrs:{href:"https://developer.mozilla.org/zh-CN/docs/Web/API/Service_Worker_API",target:"_blank",rel:"noopener noreferrer"}},[e._v("MDN"),v("OutboundLink")],1),e._v(" 的介绍：")]),e._v(" "),v("p",[e._v("Service Worker 是一个浏览器背后运行的脚步，独立于 web 页面，为无需一个页面或用户交互的功能打开了大门。今日，它包含了推送通知和背景异步（push notifications and background sync）的功能。将来，Service Worker 将支持包括 periodic sync or geofencing 的功能。")]),e._v(" "),v("p",[e._v("基本上，Service Worker 是 Web Worker 的一个类型，更具体地说，它像 "),v("a",{attrs:{href:"https://developer.mozilla.org/en-US/docs/Web/API/SharedWorker",target:"_blank",rel:"noopener noreferrer"}},[e._v("Shared Worker"),v("OutboundLink")],1),e._v("：")]),e._v(" "),v("ul",[v("li",[e._v("Service Worker 在其自己的全局上下文中运行")]),e._v(" "),v("li",[e._v("它没有绑定到特定的网页")]),e._v(" "),v("li",[e._v("它不能访问到 DOM")])]),e._v(" "),v("p",[e._v("这是一个令人兴奋的 API 的原因是它允许你支持离线体验，让开发人员完全控制体验。")]),e._v(" "),v("h2",{attrs:{id:"_2-service-worker-的生命周期"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#_2-service-worker-的生命周期","aria-hidden":"true"}},[e._v("#")]),e._v(" 2. Service Worker 的生命周期")]),e._v(" "),v("p",[e._v("Service Worker 的生命周期与 web 页面完全分离。它包括以下几个阶段:")]),e._v(" "),v("ul",[v("li",[e._v("下载")]),e._v(" "),v("li",[e._v("安装")]),e._v(" "),v("li",[e._v("激活")])]),e._v(" "),v("h3",{attrs:{id:"_2-1-下载"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-下载","aria-hidden":"true"}},[e._v("#")]),e._v(" 2.1 下载")]),e._v(" "),v("p",[e._v("这是浏览器下载包含 Service Worker 的 "),v("code",[e._v(".js")]),e._v(" 文件的时候。")]),e._v(" "),v("h3",{attrs:{id:"_2-2-安装"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-安装","aria-hidden":"true"}},[e._v("#")]),e._v(" 2.2 安装")]),e._v(" "),v("p",[e._v("要为 web 应用程序安装 Service Worker，必须先注册它，这可以在 JavaScript 代码中完成。注册 Service Worker 后，它会提示浏览器在后台启动 Service Worker 安装步骤。")]),e._v(" "),v("p",[e._v("通过注册 Service Worker，你可以告诉浏览器你的 Service Worker 的 JavaScript 文件的位置。看看下面的代码:")]),e._v(" "),v("p",[v("img",{attrs:{src:"https://image-static.segmentfault.com/122/077/1220774932-5c2d5f4bac078_articlex",alt:"图片描述"}})]),e._v(" "),v("p",[e._v("上例代码首先检查当前环境中是否支持 Service Worker API。如果支持，则 "),v("code",[e._v("/sw.js")]),e._v(" 这个 Service Worker 就被注册了。")]),e._v(" "),v("p",[e._v("每次页面加载时都可以调用 "),v("code",[e._v("register()")]),e._v(" 方法，浏览器会判断 Service Worker 是否已经注册，根据注册情况会对应的给出正确处理。")]),e._v(" "),v("p",[v("code",[e._v("register()")]),e._v(" 方法的一个重要细节是 Service Worker 文件的位置。在本例中，可以看到 Service Worker 文件位于域的根目录，这意味着 Service Worker 范围将是这个域下的。换句话说，这个 Service Worker 将为这个域中的所有内容接收 "),v("code",[e._v("fetch")]),e._v("事件。如果我们在 "),v("code",[e._v("/example/sw.js")]),e._v(" 注册 Service Worker 文件，那么 Service Worker 只会看到以 "),v("code",[e._v("/example/")]),e._v(" 开头的页面的 fetch 事件（例如 "),v("code",[e._v("/example/page1/")]),e._v("、"),v("code",[e._v("/example/page2/")]),e._v("）。")]),e._v(" "),v("p",[e._v("通常在安装步骤中，你需要缓存一些静态资源。 如果所有文件都缓存成功，则 Service Worker 将被安装。 如果任何文件无法下载和缓存，则安装步骤将失败，Service Worker 将不会激活（即不会被安装）。 如果发生这种情况，不要担心，下次再试一次。 但是，这意味着如果它安装，你知道你有这些静态资源在缓存中。")]),e._v(" "),v("p",[e._v("如果注册需要在加载事件之后发生，这就解答了你“注册是否需要在加载事件之后发生”的疑惑。这不是必要的，但绝对是推荐的。")]),e._v(" "),v("p",[e._v("为什么？让我们考虑用户第一次访问你的 Web 应用程序。目前还没有 Service Worker，而且浏览器无法预先知道最终是否会安装 Service Worker。如果安装了 Service Worker，浏览器将需要为这个额外的线程花费额外的 CPU 和内存，否则浏览器将把这些额外的 CPU 和内存用于呈现 Web 页面。")]),e._v(" "),v("p",[e._v("最重要的是，如果在页面上安装一个 Service Worker，就可能会有延迟加载和渲染的风险 —— 而不是尽快让你的用户可以使用该页面。")]),e._v(" "),v("p",[e._v("注意，这种情况对第一次的访问页面时才会有。后续的页面访问不会受到 Service Worker 安装的影响。一旦 Service Worker 在第一次访问页面时被激活，它就可以处理加载/缓存事件，以便后续访问 Web 应用程序。这一切都是有意义的，因为它需要准备好处理受限的的网络连接。")]),e._v(" "),v("h3",{attrs:{id:"_2-3-激活"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-激活","aria-hidden":"true"}},[e._v("#")]),e._v(" 2.3 激活")]),e._v(" "),v("p",[e._v("安装 Service Worker 之后，下一步将是激活它，这是处理旧缓存管理的好机会。")]),e._v(" "),v("p",[e._v("在激活步骤之后，Service Worker 将控制所有属于其范围的页面，尽管第一次注册 Service Worker 的页面将不会被控制，直到再次加载。")]),e._v(" "),v("p",[e._v("Service Worker 一旦掌控，它将处于以下两种状态之一：")]),e._v(" "),v("ul",[v("li",[e._v("处理从网页发出网络请求或消息时发生的提取和消息事件")]),e._v(" "),v("li",[e._v("Service Worker 将被终止以节省内存")])]),e._v(" "),v("p",[e._v("Service Worker 生命周期如下：")]),e._v(" "),v("p",[v("img",{attrs:{src:"https://image-static.segmentfault.com/895/149/895149436-5aea8701ad461_articlex",alt:"图片描述"}})]),e._v(" "),v("h2",{attrs:{id:"_3-service-worker-安装的内部机制"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#_3-service-worker-安装的内部机制","aria-hidden":"true"}},[e._v("#")]),e._v(" 3. Service Worker 安装的内部机制")]),e._v(" "),v("p",[e._v("在页面启动注册过程之后，看看 Service Worker 脚本中发生了什么，它通过向 Service Worker 实例添加事件监听来处理 "),v("code",[e._v("install")]),e._v(" 事件：")]),e._v(" "),v("p",[e._v("以下是处理安装事件时需要采取的步骤:")]),e._v(" "),v("ul",[v("li",[e._v("开启一个缓存")]),e._v(" "),v("li",[e._v("缓存我们的文件")]),e._v(" "),v("li",[e._v("确认是否缓存了所有必需的资源")])]),e._v(" "),v("p",[e._v("对于最基本的示例，你需要为安装事件定义回调并决定要缓存哪些文件。")]),e._v(" "),v("div",{staticClass:"language-js extra-class"},[v("pre",{pre:!0,attrs:{class:"language-js"}},[v("code",[e._v("self"),v("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),v("span",{pre:!0,attrs:{class:"token function"}},[e._v("addEventListener")]),v("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),v("span",{pre:!0,attrs:{class:"token string"}},[e._v("'install'")]),v("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" "),v("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("function")]),v("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),v("span",{pre:!0,attrs:{class:"token parameter"}},[e._v("event")]),v("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" "),v("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v(" "),v("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// Perform install steps });")]),e._v("\n")])])]),v("p",[e._v("下面是 Service Worker 简单的一个内部安装过程:")]),e._v(" "),v("p",[v("img",{attrs:{src:"https://image-static.segmentfault.com/147/613/1476137467-5c2dcad06da50_articlex",alt:"图片描述"}})]),e._v(" "),v("p",[e._v("从上例代码可以得到：")]),e._v(" "),v("p",[e._v("调用了"),v("code",[e._v("caches.open()")]),e._v(" 和我们想要的缓存名称, 之后调用 "),v("code",[e._v("cache.addAll()")]),e._v(" 并传入文件数组。 这是一个promise 链（ caches.open() 和 cache.addAll() ）。 "),v("code",[e._v("event.waitUntil()")]),e._v(" 方法接受一个承诺，并使用它来知道安装需要多长时间，以及它是否成功。")]),e._v(" "),v("p",[e._v("如果成功缓存了所有文件，那么将安装 Service Worker。如果其中的一个文件下载失败，那么安装步骤将失败。这意味着需要小心在安装步骤中决定要缓存的文件列表，定义一长串文件将增加一个文件可能无法缓存的机会，导致你的 Service Worker 没有得到安装。")]),e._v(" "),v("p",[e._v("处理 "),v("code",[e._v("install")]),e._v(" 事件完全是可选的，你可以避免它，在这种情况下，你不需要执行这里的任何步骤。")]),e._v(" "),v("h2",{attrs:{id:"_4-运行时缓存请求"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#_4-运行时缓存请求","aria-hidden":"true"}},[e._v("#")]),e._v(" 4. 运行时缓存请求")]),e._v(" "),v("p",[e._v("安装了 Service Worker 后，用户导航到另一个页面或刷新所在的页面，Service Worker 将收到 "),v("code",[e._v("fetch")]),e._v(" 事件。下面是一个例子，演示如何返回缓存的资源或执行一个新的请求，然后缓存结果:")]),e._v(" "),v("p",[v("img",{attrs:{src:"https://image-static.segmentfault.com/353/303/3533039261-5c2dd74e6de42_articlex",alt:"图片描述"}})]),e._v(" "),v("p",[e._v("上述流程：")]),e._v(" "),v("ul",[v("li",[e._v("在这里我们定义了 "),v("code",[e._v("fetch")]),e._v(" 事件，在 "),v("code",[e._v("event.respondWith()")]),e._v(" 中，我们传递了一个来自 "),v("code",[e._v("caches.match()")]),e._v(" 的 "),v("strong",[e._v("promise")]),e._v("。 此方法查看请求，并查找来自 Service Worker 创建的任何缓存的任何缓存结果。")]),e._v(" "),v("li",[e._v("如果在缓存中，响应内容就被恢复了。")]),e._v(" "),v("li",[e._v("否则，将会执行 fetch。")]),e._v(" "),v("li",[e._v("检查状态码是不是 200，同时检查响应类型是 basic，表明响应来自我们最初的请求。在这种情况下，不会缓存对第三方资源的请求。")]),e._v(" "),v("li",[e._v("响应被缓存下来")])]),e._v(" "),v("p",[e._v("如果通过检查，克隆响应。这是因为响应是 Stream，所以只能消耗一次。既然要返回浏览器使用的响应，并将其传递给缓存使用，就需要克隆它，以便可以一个发送到浏览器，一个发送到缓存。")]),e._v(" "),v("h2",{attrs:{id:"_5-更新-service-worker"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#_5-更新-service-worker","aria-hidden":"true"}},[e._v("#")]),e._v(" 5. 更新 Service Worker")]),e._v(" "),v("p",[e._v("当用户访问你的 Web 应用程序时，浏览器试图重新下载包含 Service Worker 代码的 "),v("code",[e._v(".js")]),e._v(" 文件，这是在后台完成的。")]),e._v(" "),v("p",[e._v("如果现在下载的 Service Worker 的文件与当前 Service Worker 的文件相比如果有一个字节及以上的差异，浏览器将假设 Service Worker 文件已改过，浏览器就会启动新的 Service Worker。")]),e._v(" "),v("p",[e._v("新的 Service Worker 将启动并且安装事件将被移除。然而，在这一点上，旧的 Service Worker 仍在控制你的 web 应用的页面，这意味着新的 Service Worker 将进入 "),v("code",[e._v("waiting")]),e._v(" 状态。")]),e._v(" "),v("p",[e._v("一旦你的 Web 应用程序当前打开的页面被关闭，旧的 Service Worker 将被浏览器杀死，新 Service Worker 接管了控制权，它的激活事件将被激发")]),e._v(" "),v("p",[e._v("为什么需要这些？为了避免 Web 应用程序的两个版本同时在不同的 tab 上运行的问题——这在 Web 上是非常常见的，并且可能会产生非常严重的bug(例如，在浏览器中本地存储数据时使用不同的模式)。")]),e._v(" "),v("h2",{attrs:{id:"_6-从缓存中删除数据"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#_6-从缓存中删除数据","aria-hidden":"true"}},[e._v("#")]),e._v(" 6. 从缓存中删除数据")]),e._v(" "),v("p",[e._v("在激活回调中发生的一个常见任务是缓存管理。你要在激活回调中这样做的原因是，如果你要在安装步骤中清除所有旧的缓存，任何保留所有当前页面的旧 Service Worker 将会突然停止服务来自该缓存的文件。")]),e._v(" "),v("p",[e._v("这里提供了一个如何从缓存中删除一些不在白名单中的文件的例子（在本例中，有 page-1、page-2 两个实体）：")]),e._v(" "),v("p",[v("img",{attrs:{src:"https://image-static.segmentfault.com/289/408/2894083221-5c2dde61046bf_articlex",alt:"图片描述"}})]),e._v(" "),v("h2",{attrs:{id:"_7-要求-https-的原因"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#_7-要求-https-的原因","aria-hidden":"true"}},[e._v("#")]),e._v(" 7. 要求 HTTPS 的原因")]),e._v(" "),v("p",[e._v("在构建 Web 应用程序时，通过 localhost 使用 Service Workers，但是一旦将其部署到生产环境中，就需要准备好 HTTPS( 这是使用HTTPS 的最后一个原因)。")]),e._v(" "),v("p",[e._v("使用 Service Worker，可以很容易被劫持连接并伪造响应。如果不使用 HTTPs，人的web应用程序就容易受到黑客的攻击。")]),e._v(" "),v("p",[e._v("为了更安全，你需要在通过 HTTPS 提供的页面上注册 Service Worker，以便知道浏览器接收的 Service Worker 在通过网络传输时未被修改。")]),e._v(" "),v("h2",{attrs:{id:"_8-浏览器支持"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#_8-浏览器支持","aria-hidden":"true"}},[e._v("#")]),e._v(" 8. 浏览器支持")]),e._v(" "),v("p",[e._v("浏览器对 Service Worker 的支持正在变得越来越好：")]),e._v(" "),v("p",[v("img",{attrs:{src:"https://image-static.segmentfault.com/301/834/3018349471-5ae8f008e2636_articlex",alt:"图片描述"}})]),e._v(" "),v("h2",{attrs:{id:"_9-service-workers-特性将越来越完善及强大"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#_9-service-workers-特性将越来越完善及强大","aria-hidden":"true"}},[e._v("#")]),e._v(" 9. Service Workers 特性将越来越完善及强大")]),e._v(" "),v("p",[e._v("Service Workers 提供的一些独特特性包括:")]),e._v(" "),v("ul",[v("li",[v("strong",[e._v("推送通知")]),e._v(" — 允许用户选择从网络应用程序及时更新。")]),e._v(" "),v("li",[v("strong",[e._v("后台同步")]),e._v(" — 允许延迟操作，直到用户具有稳定的连接。通过这种方式，可以确保用户想发送的任何内容实都可以发送。")]),e._v(" "),v("li",[v("strong",[e._v("定期同步(后续开放)")]),e._v(" — 提供管理定期后台同步功能的 API。")]),e._v(" "),v("li",[v("strong",[e._v("Geofencing (后续开放)")]),e._v(" — 可以定义参数，也称为围绕感兴趣领域的 geofences。当设备通过geofence 时，Web 应用程序会收到一个通知，该通知允许根据用户的地理位置提供更好的体验。")])]),e._v(" "),v("p",[v("strong",[e._v("原文：")])]),e._v(" "),v("p",[v("a",{attrs:{href:"https://blog.sessionstack.com/how-javascript-works-service-workers-their-life-cycle-and-use-cases-52b19ad98b58",target:"_blank",rel:"noopener noreferrer"}},[e._v("https://blog.sessionstack.com..."),v("OutboundLink")],1)])])},[],!1,null,null,null);r.default=a.exports}}]);